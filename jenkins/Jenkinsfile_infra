pipeline{ 
    agent any
     environment {
		TF_IN_AUTOMATION = 'true'
		CREDENTIALS = credentials('terraform_creds')
    }
    tools {
      terraform 'terraform'
    }
    stages{ 
		stage('Git Checkout'){
			steps {
				script {
					git branch: 'main', credentialsId: 'gitcreds', url: 'git@github.com:CapybaraDevOps/geocit-infrastructure.git'
				}
			}
		}
		stage('Terraform'){
			steps {
                withCredentials([[$class: 'FileBinding', credentialsId: 'terraform_creds', variable: 'JSON_KEY']]) {
					sh 'gcloud auth activate-service-account --key-file $JSON_KEY'
					sh 'terraform init'
					sh 'terraform plan'

				}
			}
		}
		stage('IP Output'){
			steps {
				script {
                    def ips = sh(script: 'terraform output -json', returnStdout: true).trim()
                    writeFile file: '/var/lib/jenkins/hostaddresses', text: ips
                }
			}
		}
    }  
}