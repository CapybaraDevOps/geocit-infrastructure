pipeline {
    agent any
	tools {
      terraform 'terraform'
    }
    stages {
        stage('Init and Plan'){
			steps {
			    withCredentials([file(credentialsId: 'terraform_creds', variable: 'GOOGLE_CREDENTIALS')]) {
			        dir('terraform/geo_tf') {
			            sh 'make plan'
			        }
			    }
			}
		}
		stage('Validation'){
			input {
				message "Do you want to approve this plan?"
				ok "Approve this plan"
			}
			steps {
			    echo "Approval accepted"
			}
		}
		stage('Approve'){
			steps {
			    withCredentials([file(credentialsId: 'terraform_creds', variable: 'GOOGLE_CREDENTIALS')]) {
			        dir('terraform/geo_tf') {
			            sh 'make apply'
			        }
			    }
			}
		}
    }
    post {
        always {
            cleanWs()
        }
    }
}