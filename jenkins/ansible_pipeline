pipeline {
    agent any

    stages {
        stage('Checkout') { 
            steps {
                script {
                    final String content = readFile(file: "../../hostadresses")
                    final List hosts = extractLines(content)
                    properties([
                        parameters([
                            string(
                                defaultValue: '10.156.0.48', 
                                name: 'GRAFANAIP', 
                                trim: true
                            )
                        ])
                    ])
                    git branch: 'jira-51-configure-ansible-for-the-application', url: "git@github.com:CapybaraDevOps/geocit-infrastructure.git", credentialsId: 'gitcreds'
                    for (i = 0; i < hosts.size(); i++) {
                        env.LoopHost = hosts[i]
                        env.CurrentIndex = i
                        sh "ssh-keygen -f '/var/lib/jenkins/.ssh/known_hosts' -R '${env.LoopHost}'"
                        sshagent(credentials : ['ansible']) {
                            sh "ssh -o StrictHostKeyChecking=no ansible@${env.LoopHost}"
                            sh "exit"
                        }
                        sh "sed -i -e '/grafana:/ i TAB${env.LoopHost}:' ansible/inventory.yml"
                    }
                    sh "sed -i 's/TAB/    /' ansible/inventory.yml"
                    env.Grafana = params.GRAFANAIP
                    sshagent(credentials : ['ansible']) {
                        sh "ssh -o StrictHostKeyChecking=no ansible@${env.Grafana}"
                        sh "exit"
                    }
                    sh "sed -i -e \'s/monitoring_ip/${env.Grafana}/g\' ansible/inventory.yml"
                }
            }
        }
        stage('Deploy') {
            steps {
                dir('ansible/roles') {
                    ansiblePlaybook playbook: '../geocitizen-playbook.yml', inventory: '../inventory.yml', credentialsId: 'ansible'
                }
            }
        }
    }
}

@NonCPS
List extractLines(final String content) {
    List hosts = []
    content.eachLine { line -> 
        hosts << line
    }
    return hosts
}