pipeline {
    agent any
    tools {
        maven "M3"
    }
    stages {
        stage('git checkout') {
            steps{
                script {
                    git branch: 'main', credentialsId: 'gitcreds', url: 'git@github.com:CapybaraDevOps/geocit.git'
                }
            }
        }
        stage('Get IP') {
                steps{
                    script {
                    def extractIpsScript = '''
                        #!/bin/bash
                        output_file="ip_addresses.txt"
                        gcloud compute instances list --format=table\\(name,networkInterfaces[0].networkIP\\) | \
                        awk \'NR>1 && $1 != "jenkins-vm" && $1 != "monitoring1" {print $1}\' > "$output_file"

                        while IFS= read -r ip; do
                            echo "$ip"
                        done < "$output_file"

                        echo "IP addresses have been saved to $output_file"
                    '''
                    sh extractIpsScript
                    env.IP_ADDRESSES = readFile('ip_addresses.txt').trim()

                    def addressesList = sh(script: "gcloud compute addresses list --format=json", returnStdout: true).trim()
                    def json = readJSON text: addressesList
                    def externalIp = json.find { it.TYPE == 'EXTERNAL' }?.ADDRESS
                    if (externalIp) {
                        env.EXTERNAL_IP = externalIp
                        echo "External IP: ${externalIp}"
                    } else {
                        error "No external IP address found with type EXTERNAL."
                    }
                    }

                    def dbInfo = sh(script: "gcloud sql instances describe postgres-db --format=json", returnStdout: true).trim()
                    def json = readJSON text: dbInfo
                    def dbIp = json.ipAddresses.find { it.type == 'PRIVATE' }?.ipAddress
                    if (dbIp) {
                        env.DB_IP = dbIp
                        echo "DB IP: ${dbIp}"
                    } else {
                        error "No DB IP address found."
                    }
                }
        }
        stage('Build Back-end') {
                steps{
                    sh "mvn clean package -Dmaven.test.skip=true"
                }
        }
        stage('Test Back-end') {
                steps{
                    sh "mvn test"
                }
        }
        stage('Deploy') {
            steps {
                script {
                    withCredentials([file(credentialsId: 'terraform_creds', variable: 'GOOGLE_CREDENTIALS')]) {
                        env.IP_ADDRESSES.split('\n').each { instance_name ->
                            sh "gcloud compute scp /var/lib/jenkins/workspace/Deploy/target/citizen.war tomcat@${instance_name}:/opt/tomcat/webapps/ --zone=europe-west3-c"
                        }
                    }
                }
            }
        }
    }
    post {
        always {
            cleanWs()
        }
    }
}
